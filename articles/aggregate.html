<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>What if the Unit of Analysis is not the same as the Unit of Labeling? • dsl</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="What if the Unit of Analysis is not the same as the Unit of Labeling?">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dsl</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/intro.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/model.html">Models available in DSL</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/faq.html">Frequently Asked Questions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/aggregate.html">Units of Analysis and Labeling Differ</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>What if the Unit of Analysis is not the same as the Unit of Labeling?</h1>
            
      

      <div class="d-none name"><code>aggregate.Rmd</code></div>
    </div>

    
    
<p><br></p>
<p><strong>On this page, we explain how to setup data for
<code>dsl</code> when the unit of analysis is not the same as the unit
of labeling.</strong></p>
<div class="section level3">
<h3 id="over">
<strong>Overview</strong><a class="anchor" aria-label="anchor" href="#over"></a>
</h3>
<p class="lh-lg">
</p>
<p>In some applications, the unit of analysis is not the same as the
unit of labeling. Researchers often annotate each document, but the unit
of analysis might be some aggregates of documents. For example, users
might code whether each online post by political candidates mentions an
economic policy: the unit of labeling is at the online post level. But
researchers might be interested in how the proportion of posts
mentioning an economic policy varies between different candidates: the
unit of analysis is at the candidate level. Here, each candidate has
multiple posts, and the main text-based variable is defined as the
proportion of online posts mentioning an economic policy for each
candidate.</p>
<p>In such applications, how can users apply DSL? In general, DSL should
be applied at the unit of analysis (i.e., the candidate-level data).
Then, how can we prepare the candidate-level data from the post-level
data that are expert-coded? We need two simple steps: (1) aggregating
expert-coding and (2) aggregating sampling probabilities</p>
<p><br></p>
<div class="section level4">
<h4 id="aggregating-expert-coding">
<strong>1. Aggregating Expert-Coding</strong><a class="anchor" aria-label="anchor" href="#aggregating-expert-coding"></a>
</h4>
<p class="lh-lg">
</p>
<p>First, we discuss how to aggregate expert coding at the post-level
data up to the candidate-level data.</p>
<p>We start with the post level data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://naokiegami.com/dsl/">dsl</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data_post"</span><span class="op">)</span> <span class="co"># example data </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_post</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   cand_id post_id economy pred_economy post_sample_prob</span></span>
<span><span class="co">## 1       1     1_1       0            0              0.3</span></span>
<span><span class="co">## 2       1     1_2       0            1              0.3</span></span>
<span><span class="co">## 6       2     2_1      NA            0              0.3</span></span>
<span><span class="co">## 7       2     2_2      NA            1              0.3</span></span>
<span><span class="co">## 3       3     3_1       1            1              0.3</span></span>
<span><span class="co">## 4       3     3_2       0            0              0.3</span></span>
<span><span class="co">## 5       3     3_3      NA            0              0.3</span></span></code></pre>
<p>In this data, variable <code>economy</code> represents expert-coded
labels about whether a given post mentions an economic policy. The first
candidate has two posts that are all labeled, and for this candidate, we
can compute the proportion of online posts mentioning an economic policy
to be <code>0</code>. For the second candidates, none of the posts are
labeled, so this second candidate is not labeled. For the third
candidate, two of the posts are labeled. As long as posts are randomly
selected for expert annotations, researchers can use the mean of labeled
posts to estimate the proportion of online posts mentioning an economic
policy to be <code>0.5</code> for this particular candidate.</p>
<p>Variable <code>pred_economy</code> represents text labels predicted
by a user-specified automated text annotation method. Variable
<code>post_sample_prob</code> is the post-level sampling probability for
labeling. In this example, all the posts have the equal probability of
being sampled with 30%.</p>
<p>In general, when posts are randomly selected for expert annotations,
users can compute the expert-coded <code>mean_economy</code> variable at
the candidate-level by ignoring <code>NAs</code> and computing the
proportion of online posts mentioning an economic policy just focusing
on labeled documents. For candidates that do not have any labeled posts,
those candidates will be recorded as non-labeled in the candidate-level
data. For variable <code>pred_economy</code>, users can directly compute
the mean within each candidate.</p>
<p>Users can implement this step by simply using <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code>
and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize()</a></code> functions in <code>tidyverse</code> or
using <code><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">economy_cand</span> <span class="op">&lt;-</span> <span class="va">data_post</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cand_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean_economy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">economy</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>            mean_pred_economy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pred_economy</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Turn NaN to NA (get ready for `dsl`)</span></span>
<span><span class="va">economy_cand</span><span class="op">$</span><span class="va">mean_economy</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan</a></span><span class="op">(</span><span class="va">economy_cand</span><span class="op">$</span><span class="va">mean_economy</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">economy_cand</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">##   cand_id mean_economy mean_pred_economy</span></span>
<span><span class="co">##     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>       1          0               0.5  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>       2         <span style="color: #BB0000;">NA</span>               0.5  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>       3          0.5             0.333</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>       4          0               0.5  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>       5          0               0.25 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>       6         <span style="color: #BB0000;">NA</span>               0.667</span></span></code></pre>
<p>At the candidate-level, variable <code>mean_economy</code> is the
expert-coded proportion of posts mentioning an economic policy, and
variable <code>mean_pred_economy</code> is the predicted proportion of
posts mentioning an economic policy.</p>
<p>Here, we are using the mean to aggregate posts within each candidate,
but users can use any function of their choice to define their
text-based variable. In general, as long as posts are randomly selected
for expert annotations, users simply need to apply their definition of
text-based variables for labeled documents (ignoring non-labeled
documents) and treat candidates that have no labeled posts as
non-labeled.</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="aggregating-sampling-probabilities">
<strong>2. Aggregating Sampling Probabilities</strong><a class="anchor" aria-label="anchor" href="#aggregating-sampling-probabilities"></a>
</h4>
<p class="lh-lg">
</p>
<p>Users also need to translate the sampling probability from the
post-level to the candidate-level.</p>
<p>In particular, the sampling probability of having expert-coding for
each candidate is the probability of having expert-coding on at least
one document within each candidate. When users randomly sample
documents, they need to take into account different numbers of posts
within each candidate. This is because if a given candidate has more
posts, she is more likely to have at least one expert-coded
document.</p>
<p>To compute this properly, users can rely on the following simple
function. Mathematically this computes the probability of having at
least one expert annotation for each candidate.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cand_sample_prob</span> <span class="op">&lt;-</span> <span class="va">data_post</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cand_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>cand_sample_prob <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">post_sample_prob</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cand_sample_prob</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">##   cand_id cand_sample_prob</span></span>
<span><span class="co">##     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>       1            0.51 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>       2            0.51 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>       3            0.657</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>       4            0.760</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>       5            0.760</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>       6            0.657</span></span></code></pre>
<p>If users already know that their main statistical analyses are at the
candidate level, they can consider two-stage sampling, i.e., randomly
sample candidates first and then randomly sample posts within each
candidate. Using this two-stage sampling will make the calculation of
the sampling probabilities at the candidate level even simpler. They
have to just use the first stage (the probability of sampling each
candidate for expert annotations).</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="merging-other-candidate-level-data">
<strong>3. Merging Other Candidate-level data</strong><a class="anchor" aria-label="anchor" href="#merging-other-candidate-level-data"></a>
</h4>
<p class="lh-lg">
</p>
<p>To prepare the final candidate-level data, we can combine two data
sets above as well as other candidate-level data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First we merge (mean_economy, mean_pred_economy) and cand_sample_prob</span></span>
<span><span class="va">cand_main</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">economy_cand</span>, <span class="va">cand_sample_prob</span>, by <span class="op">=</span> <span class="st">"cand_id"</span><span class="op">)</span></span></code></pre></div>
<p>Then, users might merge some candidate-level data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data_cand"</span><span class="op">)</span> <span class="co"># example candidate-level data </span></span>
<span><span class="va">data_cand_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">cand_main</span>, <span class="va">data_cand</span>, by <span class="op">=</span> <span class="st">"cand_id"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_cand_merged</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   cand_id mean_economy mean_pred_economy cand_sample_prob gender edu ideology</span></span>
<span><span class="co">## 1       1          0.0         0.5000000           0.5100      0   2        5</span></span>
<span><span class="co">## 2       2           NA         0.5000000           0.5100      0   4        3</span></span>
<span><span class="co">## 3       3          0.5         0.3333333           0.6570      1   4        2</span></span>
<span><span class="co">## 4       4          0.0         0.5000000           0.7599      1   4        3</span></span>
<span><span class="co">## 5       5          0.0         0.2500000           0.7599      0   5        4</span></span>
<span><span class="co">## 6       6           NA         0.6666667           0.6570      1   4        3</span></span></code></pre>
<p><br></p>
</div>
<div class="section level4">
<h4 id="fitting-dsl-with-the-candidate-level-data">
<strong>4. Fitting DSL with the Candidate-level Data</strong><a class="anchor" aria-label="anchor" href="#fitting-dsl-with-the-candidate-level-data"></a>
</h4>
<p class="lh-lg">
</p>
<p>Finally, run <code>dsl</code> on the candidate-level data by
specifying the sampling probability.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dsl.html">dsl</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"lm"</span>, </span>
<span>               formula <span class="op">=</span> <span class="va">mean_economy</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">edu</span> <span class="op">+</span> <span class="va">ideology</span>,</span>
<span>               predicted_var <span class="op">=</span>  <span class="st">"mean_economy"</span>,</span>
<span>               prediction <span class="op">=</span> <span class="st">"mean_pred_economy"</span>,</span>
<span>               sample_prob <span class="op">=</span> <span class="st">"cand_sample_prob"</span>,</span>
<span>               data <span class="op">=</span> <span class="va">data_cand_merged</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cross-Fitting: 1/10..2/10..3/10..4/10..5/10..6/10..7/10..8/10..9/10..10/10..</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out_agg</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ==================</span></span>
<span><span class="co">## DSL Specification:</span></span>
<span><span class="co">## ==================</span></span>
<span><span class="co">## Model:  lm</span></span>
<span><span class="co">## Call:  mean_economy ~ gender + edu + ideology</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Predicted Variables:  mean_economy</span></span>
<span><span class="co">## Prediction:  mean_pred_economy</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Labeled Observations:  674</span></span>
<span><span class="co">## Random Sampling for Labeling with Equal Probability:  No</span></span>
<span><span class="co">## (Sampling probabilities are defined in `sample_prob`)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## =============</span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## =============</span></span>
<span><span class="co">##             Estimate Std. Error CI Lower CI Upper p value    </span></span>
<span><span class="co">## (Intercept)   0.4057     0.0696   0.2693   0.5421  0.0000 ***</span></span>
<span><span class="co">## gender       -0.0099     0.0348  -0.0780   0.0583  0.3883    </span></span>
<span><span class="co">## edu           0.0005     0.0128  -0.0246   0.0256  0.4852    </span></span>
<span><span class="co">## ideology     -0.0091     0.0134  -0.0353   0.0172  0.2493    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## 95% confidence intervals (CI) are reported.</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Naoki Egami, Musashi Hinck, Brandon M. Stewart, Hanying Wei.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
